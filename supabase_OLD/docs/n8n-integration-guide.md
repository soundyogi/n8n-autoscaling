# n8n Agent Node Integration Guide

## Quick Setup (2 Minutes)

### 1. Run Compatibility Script
Execute in your Supabase SQL Editor:
```sql
-- Copy and run the entire contents of:
-- sql/9_n8n_compatibility.sql
```

### 2. Configure n8n Agent Node
- **Function Name**: `match_documents`
- **Parameters**:
  - `query_embedding`: vector(384) - [Auto-generated by n8n]
  - `match_count`: int - [Optional, default: 10]
  - `filter`: jsonb - [Optional, default: {}]

### 3. Test the Integration
```sql
-- Test in Supabase SQL Editor first:
SELECT * FROM match_documents(
    (SELECT embedding FROM knowledge_base LIMIT 1),
    3,
    '{}'
);
```

## Function Details

### Input Parameters
```typescript
interface MatchDocumentsParams {
  query_embedding: number[];    // 384-dimensional vector
  match_count?: number;         // Limit results (default: 10)
  filter?: Record<string, any>; // Metadata filter (default: {})
}
```

### Output Format
```typescript
interface MatchDocumentsResult {
  id: number;           // Converted from UUID
  content: string;      // Document content
  metadata: {           // Rich metadata from our schema
    source: string;
    priority: number;
    tags: string[];
    created_at: string;
    updated_at: string;
    original_id: string; // Original UUID
  };
  similarity: number;   // 0-1 similarity score
}
```

### Example Metadata Filtering
```javascript
// In n8n, use filter parameter like:
{
  "priority": 5,        // Only high-priority documents
  "source": "manual"    // Only manually added content
}
```

## Troubleshooting

### Common Issues

1. **Function Not Found**
   - Ensure `sql/9_n8n_compatibility.sql` is executed
   - Check function exists: `SELECT * FROM pg_proc WHERE proname = 'match_documents';`

2. **Wrong Parameter Order**
   - n8n expects: `(embedding, count, filter)`
   - Our function provides exactly this signature

3. **Embedding Dimension Mismatch**
   - Our system uses 384 dimensions (HuggingFace BAAI/bge-small-en-v1.5)
   - Ensure n8n agent is configured for 384-dim embeddings

4. **No Results Returned**
   - Check if knowledge base has data: `SELECT COUNT(*) FROM knowledge_base;`
   - Verify embeddings exist: `SELECT COUNT(*) FROM knowledge_base WHERE embedding IS NOT NULL;`

### Validation Script
Run in Supabase to verify everything works:
```sql
-- Check function signature
SELECT routine_name, parameter_name, data_type, ordinal_position
FROM information_schema.parameters 
WHERE specific_name IN (
    SELECT specific_name FROM information_schema.routines 
    WHERE routine_name = 'match_documents'
)
ORDER BY ordinal_position;

-- Test function call
SELECT 
    id, 
    left(content, 50) as preview,
    similarity,
    metadata->'source' as source
FROM match_documents(
    (SELECT embedding FROM knowledge_base WHERE embedding IS NOT NULL LIMIT 1),
    2,
    '{}'
);
```

## Integration Benefits

- ✅ **Immediate n8n compatibility** - no code changes needed
- ✅ **Preserves rich metadata** - tags, priority, source available in results
- ✅ **Maintains search quality** - same underlying similarity algorithm
- ✅ **Zero breaking changes** - existing system continues working perfectly
- ✅ **Flexible filtering** - supports complex metadata queries

## Related Documentation
- [Architecture Comparison](architecture-comparison.md) - Technical details
- [Implementation Log](scratchpad.md) - Complete development history
- [Main README](../README.md) - Full system overview

---
**Status**: Ready for immediate n8n integration ✅  
**Last Updated**: June 3, 2025
